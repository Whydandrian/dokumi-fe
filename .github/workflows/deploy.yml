name: Deploy Dokumi FE to VPS (Self-hosted)

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: [self-hosted, Linux, X64]

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Node
      uses: actions/setup-node@v4
      with:
        node-version: '24'
        cache: 'npm'
    
    - name: Install deps
      run: npm ci

    - name: Create env
      run: |
        if [ -n "${{ secrets.ENV_PRODUCTION }}" ]; then
          echo "${{ secrets.ENV_PRODUCTION }}" > .env.production
        fi
        if [ -n "${{ secrets.NEXT_PUBLIC_API_URL }}" ]; then
          echo "NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}" >> .env.production
        fi

    - name: Build
      run: npm run build
      env:
        NODE_ENV: production

    - name: Install production deps only
      run: |
        rm -rf node_modules
        npm ci --production

    - name: Deploy locally
      run: |
        set -e
        DEPLOY_DIR=/var/www/dokumi-fe    # ganti sesuai VPS_PATH
        sudo mkdir -p $DEPLOY_DIR
        sudo chown $USER:$USER $DEPLOY_DIR

        # Backup
        TIMESTAMP=$(date +%Y%m%d-%H%M%S)
        tar -czf /tmp/backup-dokumi-fe-$TIMESTAMP.tar.gz -C $DEPLOY_DIR . || true

        # Copy files (sesuaikan)
        rsync -a --delete .next node_modules public package.json package-lock.json next.config.js .env.production $DEPLOY_DIR/

        # set permission & restart pm2
        sudo chmod -R 755 $DEPLOY_DIR
        pm2 restart dokumi-fe || pm2 start npm --name "dokumi-fe" -- start

    - name: Health check
      run: |
        sleep 5
        curl -sSf http://localhost:4000/ || exit 1
