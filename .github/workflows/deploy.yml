name: Deploy Dokumi FE to VPS

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout Repository
      uses: actions/checkout@v4

    - name: üîß Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: üì¶ Install Dependencies
      run: npm ci

    - name: üìù Create Environment Files
      run: |
        # Jika ada ENV_PRODUCTION di secrets
        if [ -n "${{ secrets.ENV_PRODUCTION }}" ]; then
          echo "${{ secrets.ENV_PRODUCTION }}" > .env.production
        fi
        
        # Atau buat manual dengan API URL
        if [ -n "${{ secrets.NEXT_PUBLIC_API_URL }}" ]; then
          echo "NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}" >> .env.production
        fi

    - name: üèóÔ∏è Build Application
      run: npm run build
      env:
        NODE_ENV: production

    - name: üßπ Install Production Dependencies Only
      run: |
        rm -rf node_modules
        npm ci --production

    - name: üì¶ Create Deployment Package
      run: |
        tar -czf deploy.tar.gz \
          .next \
          node_modules \
          public \
          package.json \
          package-lock.json \
          next.config.js \
          .env.production 2>/dev/null || tar -czf deploy.tar.gz \
          .next \
          node_modules \
          public \
          package.json \
          package-lock.json \
          next.config.js

    - name: üöÄ Upload to VPS
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        source: "deploy.tar.gz"
        target: "/tmp/"
        timeout: 300s

    - name: üîÑ Deploy on VPS
      id: deploy
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        timeout: 300s
        script: |
          set -e
          
          echo "üì¶ Starting deployment..."
          
          # Store backup filename
          BACKUP_FILE="/tmp/backup-dokumi-fe-$(date +%Y%m%d-%H%M%S).tar.gz"
          
          # Backup current build
          if [ -d "${{ secrets.VPS_PATH }}/.next" ]; then
            echo "üíæ Creating backup at $BACKUP_FILE..."
            tar -czf "$BACKUP_FILE" -C ${{ secrets.VPS_PATH }} .next node_modules 2>/dev/null || echo "Backup skipped"
            echo "BACKUP_FILE=$BACKUP_FILE" >> $GITHUB_OUTPUT
          fi
          
          # Extract deployment package
          echo "üìÇ Extracting deployment..."
          cd ${{ secrets.VPS_PATH }}
          tar -xzf /tmp/deploy.tar.gz
          
          # Set correct permissions
          echo "üîê Setting permissions..."
          chmod -R 755 node_modules/.bin 2>/dev/null || true
          
          # Restart PM2
          echo "üîÑ Restarting application..."
          export PATH=$PATH:/usr/local/bin:/usr/bin
          
          if pm2 describe ${{ secrets.PM2_APP_NAME }} > /dev/null 2>&1; then
            echo "‚ôªÔ∏è  Restarting existing application..."
            pm2 restart ${{ secrets.PM2_APP_NAME }} --update-env
          else
            echo "üöÄ Starting new application..."
            pm2 start npm --name "${{ secrets.PM2_APP_NAME }}" -- start
            pm2 save
          fi
          
          # Wait for app to start
          sleep 5
          
          # Cleanup
          echo "üßπ Cleaning up..."
          rm -f /tmp/deploy.tar.gz
          
          # Keep only last 5 backups
          cd /tmp && ls -t backup-dokumi-fe-*.tar.gz 2>/dev/null | tail -n +6 | xargs -r rm -f
          
          echo "‚úÖ Deployment completed!"
          pm2 status
    
    - name: ‚è™ Rollback on Failure
      if: failure() && steps.deploy.outcome == 'failure'
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        script: |
          echo "üí• Deployment failed! Rolling back..."
          
          # Find latest backup
          LATEST_BACKUP=$(ls -t /tmp/backup-dokumi-fe-*.tar.gz 2>/dev/null | head -1)
          
          if [ -f "$LATEST_BACKUP" ]; then
            echo "üì¶ Restoring from backup: $LATEST_BACKUP"
            cd ${{ secrets.VPS_PATH }}
            tar -xzf "$LATEST_BACKUP"
            
            export PATH=$PATH:/usr/local/bin:/usr/bin
            pm2 restart ${{ secrets.PM2_APP_NAME }}
            
            echo "‚úÖ Rollback completed!"
          else
            echo "‚ö†Ô∏è  No backup found, manual intervention required"
          fi

    - name: üè• Health Check
      run: |
        echo "‚è≥ Waiting for application to start..."
        sleep 10
        
        echo "üîç Checking application health..."
        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://${{ secrets.VPS_HOST }} || echo "000")
        
        if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "301" ] || [ "$HTTP_CODE" = "302" ]; then
          echo "‚úÖ Application is healthy (HTTP $HTTP_CODE)"
        else
          echo "‚ö†Ô∏è  Application returned HTTP $HTTP_CODE"
          echo "Check logs: ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} 'pm2 logs ${{ secrets.PM2_APP_NAME }}'"
        fi

    - name: ‚úÖ Deployment Success
      if: success()
      run: |
        echo "üéâ Deployment completed successfully!"
        echo "üåê Application: https://${{ secrets.VPS_HOST }}"
        echo "üìä Check status: ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} 'pm2 status'"
        echo "üìù View logs: ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} 'pm2 logs ${{ secrets.PM2_APP_NAME }}'"

    - name: ‚ùå Deployment Failed
      if: failure()
      run: |
        echo "üí• Deployment failed!"
        echo "üîç Troubleshooting steps:"
        echo "1. Check GitHub Actions logs above"
        echo "2. SSH to VPS: ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}"
        echo "3. Check PM2: pm2 status && pm2 logs ${{ secrets.PM2_APP_NAME }}"
        echo "4. Check Nginx: sudo systemctl status nginx"
        echo "5. Check Nginx logs: sudo tail -f /var/log/nginx/dokumi-error.log"