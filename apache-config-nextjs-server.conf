<VirtualHost *:80>
  ServerName dokumi.itk.ac.id
  ServerAlias www.dokumi.itk.ac.id

  RewriteEngine On
  # Redirect www to non-www over HTTPS
  RewriteCond %{HTTP_HOST} ^www\.(.+)$ [NC]
  RewriteRule ^(.*)$ https://%1%{REQUEST_URI} [R=301,L]

  # Redirect HTTP to HTTPS
  RewriteCond %{HTTPS} off
  RewriteRule ^(.*)$ https://dokumi.itk.ac.id%{REQUEST_URI} [R=301,L]
</VirtualHost>

<VirtualHost *:443>
  ServerName dokumi.itk.ac.id

  SSLEngine On
  SSLCertificateFile /certs/ServerCertificate-2025.crt
  SSLCertificateKeyFile /certs/itk.ac.id-2025.key
  SSLCertificateChainFile /certs/CAIntermediate-2025.crt

  ProxyPreserveHost On
  ProxyRequests Off

  # ========================================
  # BACKEND API (Flask)
  # ========================================
  ProxyPass        /docs/api/ http://127.0.0.1:5001/docs/api/
  ProxyPassReverse /docs/api/ http://127.0.0.1:5001/docs/api/
  
  ProxyPass        /api/ http://127.0.0.1:5001/
  ProxyPassReverse /api/ http://127.0.0.1:5001/

  # WebSocket
  ProxyPass        /ws/  ws://127.0.0.1:8000/ws/
  ProxyPassReverse /ws/  ws://127.0.0.1:8000/ws/

  # ========================================
  # FRONTEND (Next.js Server on port 4000)
  # ========================================
  ProxyPass        / http://127.0.0.1:4000/
  ProxyPassReverse / http://127.0.0.1:4000/

  # Enable WebSocket support for Next.js HMR (if needed)
  RewriteEngine On
  RewriteCond %{HTTP:Upgrade} websocket [NC]
  RewriteCond %{HTTP:Connection} upgrade [NC]
  RewriteRule ^/?(.*) "ws://127.0.0.1:4000/$1" [P,L]

</VirtualHost>
